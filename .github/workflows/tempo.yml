on:
  schedule:
    - cron: "30 8 * * *"
  workflow_dispatch:
jobs:
  get-tempo:
    runs-on: self-hosted
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3
      - name: GET EDF historicTEMPOStore 09-2022 - 08-2023
        run: |
          curl 'https://particulier.edf.fr/services/rest/referentiel/historicTEMPOStore?dateBegin=2022&dateEnd=2023' -o tempo_2023.json
          curl 'https://particulier.edf.fr/services/rest/referentiel/historicTEMPOStore?dateBegin=2023&dateEnd=2024' -o tempo_2024.json
      - name: Merge tempo_*.json and tempo.json
        run: |
          jq -s 'map(.dates |= map(select(.couleur != "NON_DEFINI"))) | unique_by(.dates[].date) | { "dates": map(.dates[])}' tempo_2023.json tempo_2024.json tempo.json > tempo_new.json
      - name: Replace old tempo.json file
        run: mv tempo_new.json tempo.json
      - name: Cleanup
        run: rm tempo_*.json
      - name: Commit file
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: Update tempo.json
          branch: main
          file_pattern: "tempo.json"
